import { Button, ListView, CheckBox } from "std-widgets.slint";

import { TaskItem } from "models.slint";
import { TaskEditorPopup } from "taskeditor.slint";

export component MainWindow inherits Dialog {
    // Main content as a single child element
    min-width: 480px;
    min-height: 320px;
    title: "Command Center";

    in-out property <[TaskItem]> tasks;
    in-out property <string> status;
    in-out property <string> error;

    callback refresh();
    callback run_now(id: int);

    // Use default styling without custom themes
    Rectangle {
        horizontal-stretch: 1;
        vertical-stretch: 1;

        VerticalLayout {
            padding: 12px;
            spacing: 8px;

            HorizontalLayout {
                spacing: 8px;

                Button {
                    text: "Refresh";
                    clicked => { root.refresh() }
                }

                if (error != "") : Text {
                    wrap: word-wrap;
                    text: error;
                }
                
                if (status != "") : Text {
                    wrap: word-wrap;
                    text: status;
                }

                Rectangle { horizontal-stretch: 1; } // spacer
            }

            Rectangle { height: 1px; }

            Text { font-weight: 600; text: "Scheduled Tasks"; }

            if (tasks.length == 0 && error == "") : Text { text: "No tasks found."; }

            ListView {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                for task in tasks : GridLayout {
                    // Use one Row to ensure consistent columns
                    Row {
                        // Name column with fixed min width for alignment across rows
                        Text { text: task.name; vertical-alignment: center; min-width: 200px; }
                        // Enabled column (checkbox)
                        CheckBox { checked: task.enabled; }
                        // Status column with fixed width
                        Text { text: task.enabled ? "" : "(disabled)"; vertical-alignment: center; min-width: 90px; }
                        // Spacer fills remaining width
                        Rectangle { horizontal-stretch: 1; }
                        // Actions column grouped
                        HorizontalLayout {
                            spacing: 6px;
                            if (task.enabled) : Button {
                                text: "Run Now";
                                enabled: task.enabled;
                                clicked => { root.run_now(task.id); }
                            }
                            Button {
                                text: "âœŽ Edit";
                                clicked => {
                                    editor.open_for_new();
                                    editor.visible = true;
                                }
                            }
                        }
                    }
                }
            }
        }

        // Editor dialog instance inside main content tree
        editor := TaskEditorPopup {
            visible: false;
        }
    }
}
